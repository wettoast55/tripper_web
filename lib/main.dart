import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_auth/firebase_auth.dart'; // for anonymous login
import 'package:cloud_functions/cloud_functions.dart'; // if using functions
import 'package:cloud_firestore/cloud_firestore.dart'; // for checking existing group
import 'package:shared_preferences/shared_preferences.dart'; // for storing session data

import 'firebase_options.dart'; // generated by flutterfire configure
import 'package:tripper_web/mygroup.dart';
import 'package:tripper_web/surveypage.dart';

void main() async {
  // ✅ Required to initialize Firebase before runApp
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  print('✅ Firebase initialized successfully');

  // ✅ Ensure anonymous login and check group association before runApp
  await _ensureLoggedIn();
  print('✅ User is logged in');

  // ✅ Optional: Set Firebase Functions region
  FirebaseFunctions.instanceFor(region: 'us-central1');

  runApp(const MyApp());
}

// ✅ Logs in user anonymously and checks if already in a group
Future<void> _ensureLoggedIn() async {
  final auth = FirebaseAuth.instance;
  if (auth.currentUser == null) {
    await auth.signInAnonymously();
    print('[Auth] Signed in anonymously: \${auth.currentUser?.uid}');
  } else {
    print('[Auth] Already signed in: \${auth.currentUser?.uid}');
  }

  // ✅ Check if user already belongs to a group and persist it
  final prefs = await SharedPreferences.getInstance();
  final uid = FirebaseAuth.instance.currentUser?.uid;
  if (uid != null) {
    final groups = await FirebaseFirestore.instance.collection('groups').get();
    for (final group in groups.docs) {
      final memberSnapshot = await group.reference.collection('members').where('uid', isEqualTo: uid).get();
      if (memberSnapshot.docs.isNotEmpty) {
        final groupId = group.id;
        final groupPin = group['pin'];
        final creatorId = group['creatorId'];

        await prefs.setString('groupId', groupId);
        await prefs.setString('groupPin', groupPin);
        await prefs.setString('creatorId', creatorId);
        print('[Group] User already in group: \$groupId (\$groupPin)');
        break;
      }
    }
  }
}

// ✅ Root of the app
class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Demo - TripCliques',
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(
          seedColor: const Color.fromARGB(136, 79, 97, 255),
        ),
      ),
      home: const MyHomePage(title: 'TripCliques Home Page'),
      routes: {
        '/survey': (context) => const SurveyFormPage(),
        
        // '/mygroup': (context) => const MyGroupPage(isInGroup: false, onLeaveGroup: null),
        
        // modified as null cannot be assigned to void function (not nullable)
        '/mygroup': (context) => MyGroupPage(
          isInGroup: false,
          onLeaveGroup: () {}, // no-op fallback
        ),
      },
    );
  }
}

// ✅ Stateful widget to manage tab navigation
class MyHomePage extends StatefulWidget {
  const MyHomePage({super.key, required this.title});
  final String title;

  @override
  State<MyHomePage> createState() => _MyHomePageState();
}

// ✅ Main UI and navigation logic
class _MyHomePageState extends State<MyHomePage> {
  int _selectedIndex = 0; // current tab index
  String? groupPin; // PIN of the group the user is in
  String? groupId;  // Group ID user is part of

  @override
  void initState() {
    super.initState();
    _loadGroupState();
  }

  // ✅ Load group details from SharedPreferences
  Future<void> _loadGroupState() async {
    final prefs = await SharedPreferences.getInstance();
    setState(() {
      groupPin = prefs.getString('groupPin');
      groupId = prefs.getString('groupId');
    });
  }

  // ✅ Clears local group state and removes user from Firestore group
  Future<void> _leaveGroup() async {
    final prefs = await SharedPreferences.getInstance();
    final uid = FirebaseAuth.instance.currentUser?.uid;
    final groupDocId = prefs.getString('groupId');

    if (groupDocId != null && uid != null) {
      final groupRef = FirebaseFirestore.instance.collection('groups').doc(groupDocId);
      final membersRef = groupRef.collection('members');
      final snapshot = await membersRef.where('uid', isEqualTo: uid).get();
      for (final doc in snapshot.docs) {
        await doc.reference.delete();
      }
    }

    // Clear local state
    await prefs.remove('groupId');
    await prefs.remove('groupPin');
    await prefs.remove('creatorId');

    setState(() {
      groupPin = null;
      groupId = null;
    });

    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('You have left the group.')),
    );
  }

  // ✅ Each tab corresponds to a Widget in this list
  List<Widget> get _pages => [
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: const [Text("page 1 (home/discover)")],
        ),
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: const [Text("page 2 (find trips)")],
        ),
        groupId != null
            ? MyGroupPage(
                isInGroup: true,
                onLeaveGroup: _leaveGroup,
              )
            : const Center(child: Text('Join or create a group to get started.')),
        Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: const [Text("page 4 (saved trips)")],
        ),
      ];

  // ✅ Updates selected tab
  void _onTabTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });
  }

  // ✅ Main build method
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        backgroundColor: const Color.fromARGB(255, 0, 44, 189),
        title: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(widget.title),
            if (_selectedIndex == 2 && groupPin != null && groupPin!.isNotEmpty)
              Text('PIN: $groupPin', style: const TextStyle(fontSize: 14))
          ],
        ),
      ),

      // ✅ Displays content for selected tab
      body: SizedBox.expand(child: _pages[_selectedIndex]),

      // ✅ Floating action button only appears on "My Group" page
      floatingActionButton: _selectedIndex == 2 && groupId != null
          ? FloatingActionButton(
              onPressed: () {
                // ✅ Opens the survey form in a dialog
                showDialog(
                  context: context,
                  builder: (context) => const SurveyFormPage(),
                );
              },
              tooltip: 'Open Survey',
              child: const Icon(Icons.send_and_archive_rounded),
            )
          : null,

      // ✅ Bottom navigation bar
      bottomNavigationBar: BottomNavigationBar(
        selectedItemColor: const Color.fromARGB(255, 208, 212, 255),
        backgroundColor: const Color.fromARGB(255, 0, 119, 254),
        type: BottomNavigationBarType.fixed,
        currentIndex: _selectedIndex,
        onTap: _onTabTapped,
        items: const [
          BottomNavigationBarItem(
            icon: Icon(Icons.local_fire_department),
            label: 'discover/popular',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.star),
            label: 'find trips',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.group),
            label: 'my group',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.bookmark_add),
            label: 'saved trips',
          ),
        ],
      ),
    );
  }
}
